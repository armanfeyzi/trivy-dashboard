import { useState, useMemo } from 'react';
import { ArrowUpDown, ArrowUp, ArrowDown, Download, FileText, ChevronDown, ChevronUp, Eye } from 'lucide-react';
import type { VulnerabilityReport, Vulnerability, SortField } from '@/lib/types';

interface VulnerabilityTableProps {
    reports: VulnerabilityReport[];
    isLoading?: boolean;
    onExportReport?: (report: VulnerabilityReport) => void;
    onRowClick?: (report: VulnerabilityReport) => void;
}

type SortConfig = {
    field: SortField;
    order: 'asc' | 'desc';
};

export function VulnerabilityTable({ reports, isLoading, onExportReport, onRowClick }: VulnerabilityTableProps) {
    const [sortConfig, setSortConfig] = useState<SortConfig>({ field: 'critical', order: 'desc' });
    const [expandedRow, setExpandedRow] = useState<string | null>(null);

    const handleSort = (field: SortField) => {
        setSortConfig((prev) => ({
            field,
            order: prev.field === field && prev.order === 'desc' ? 'asc' : 'desc',
        }));
    };

    const sortedReports = useMemo(() => {
        const sorted = [...reports].sort((a, b) => {
            let aValue: number | string;
            let bValue: number | string;

            switch (sortConfig.field) {
                case 'name':
                    aValue = a.containerName.toLowerCase();
                    bValue = b.containerName.toLowerCase();
                    break;
                case 'namespace':
                    aValue = a.namespace.toLowerCase();
                    bValue = b.namespace.toLowerCase();
                    break;
                case 'critical':
                    aValue = a.summary.criticalCount;
                    bValue = b.summary.criticalCount;
                    break;
                case 'high':
                    aValue = a.summary.highCount;
                    bValue = b.summary.highCount;
                    break;
                case 'medium':
                    aValue = a.summary.mediumCount;
                    bValue = b.summary.mediumCount;
                    break;
                case 'low':
                    aValue = a.summary.lowCount;
                    bValue = b.summary.lowCount;
                    break;
                case 'total':
                    aValue = a.summary.criticalCount + a.summary.highCount + a.summary.mediumCount + a.summary.lowCount;
                    bValue = b.summary.criticalCount + b.summary.highCount + b.summary.mediumCount + b.summary.lowCount;
                    break;
                default:
                    return 0;
            }

            if (aValue < bValue) return sortConfig.order === 'asc' ? -1 : 1;
            if (aValue > bValue) return sortConfig.order === 'asc' ? 1 : -1;
            return 0;
        });

        return sorted;
    }, [reports, sortConfig]);

    const SortIcon = ({ field }: { field: SortField }) => {
        if (sortConfig.field !== field) return <ArrowUpDown size={14} />;
        return sortConfig.order === 'asc' ? <ArrowUp size={14} /> : <ArrowDown size={14} />;
    };

    if (isLoading) {
        return (
            <div className="table-container">
                <div className="loading-container">
                    <div className="loading-spinner" />
                    <span className="loading-text">Loading vulnerability reports...</span>
                </div>
            </div>
        );
    }

    if (reports.length === 0) {
        return (
            <div className="table-container">
                <div className="empty-state">
                    <FileText className="empty-state-icon" />
                    <h3 className="empty-state-title">No Reports Found</h3>
                    <p className="empty-state-description">
                        No vulnerability reports match your current filters. Try adjusting your search criteria.
                    </p>
                </div>
            </div>
        );
    }

    return (
        <div className="table-container animate-fade-in">
            <table className="table">
                <thead>
                    <tr>
                        <th></th>
                        <th className="sortable" onClick={() => handleSort('name')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                Container <SortIcon field="name" />
                            </span>
                        </th>
                        <th className="sortable" onClick={() => handleSort('namespace')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                Namespace <SortIcon field="namespace" />
                            </span>
                        </th>
                        <th>Cluster</th>
                        <th className={`sortable ${sortConfig.field === 'critical' ? 'sorted' : ''}`} onClick={() => handleSort('critical')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px', color: 'var(--color-critical)' }}>
                                Critical <SortIcon field="critical" />
                            </span>
                        </th>
                        <th className={`sortable ${sortConfig.field === 'high' ? 'sorted' : ''}`} onClick={() => handleSort('high')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px', color: 'var(--color-high)' }}>
                                High <SortIcon field="high" />
                            </span>
                        </th>
                        <th className={`sortable ${sortConfig.field === 'medium' ? 'sorted' : ''}`} onClick={() => handleSort('medium')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px', color: 'var(--color-medium)' }}>
                                Medium <SortIcon field="medium" />
                            </span>
                        </th>
                        <th className={`sortable ${sortConfig.field === 'low' ? 'sorted' : ''}`} onClick={() => handleSort('low')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px', color: 'var(--color-low)' }}>
                                Low <SortIcon field="low" />
                            </span>
                        </th>
                        <th className={`sortable ${sortConfig.field === 'total' ? 'sorted' : ''}`} onClick={() => handleSort('total')}>
                            <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                Total <SortIcon field="total" />
                            </span>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {sortedReports.map((report) => {
                        const total = report.summary.criticalCount + report.summary.highCount +
                            report.summary.mediumCount + report.summary.lowCount;
                        const isExpanded = expandedRow === report.id;

                        return (
                            <>
                                <tr key={report.id}>
                                    <td style={{ width: '40px' }}>
                                        {report.vulnerabilities.length > 0 && (
                                            <button
                                                className="btn btn-icon btn-ghost"
                                                onClick={() => setExpandedRow(isExpanded ? null : report.id)}
                                                aria-label={isExpanded ? 'Collapse' : 'Expand'}
                                            >
                                                {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                                            </button>
                                        )}
                                    </td>
                                    <td>
                                        <strong style={{ color: 'var(--color-text-primary)' }}>{report.containerName}</strong>
                                        <div style={{ fontSize: 'var(--font-size-xs)', color: 'var(--color-text-tertiary)', marginTop: '2px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                            {report.name}
                                            {report.eosl && (
                                                <span className="badge badge-eosl" title="End of Service Life">
                                                    EOSL
                                                </span>
                                            )}
                                        </div>
                                    </td>
                                    <td>
                                        <span className="badge badge-namespace">{report.namespace}</span>
                                    </td>
                                    <td>
                                        <span className="badge badge-cluster">{report.cluster.toUpperCase()}</span>
                                    </td>
                                    <td>
                                        {report.summary.criticalCount > 0 ? (
                                            <span className="severity-count critical">{report.summary.criticalCount}</span>
                                        ) : (
                                            <span style={{ color: 'var(--color-text-tertiary)' }}>—</span>
                                        )}
                                    </td>
                                    <td>
                                        {report.summary.highCount > 0 ? (
                                            <span className="severity-count high">{report.summary.highCount}</span>
                                        ) : (
                                            <span style={{ color: 'var(--color-text-tertiary)' }}>—</span>
                                        )}
                                    </td>
                                    <td>
                                        {report.summary.mediumCount > 0 ? (
                                            <span className="severity-count medium">{report.summary.mediumCount}</span>
                                        ) : (
                                            <span style={{ color: 'var(--color-text-tertiary)' }}>—</span>
                                        )}
                                    </td>
                                    <td>
                                        {report.summary.lowCount > 0 ? (
                                            <span className="severity-count low">{report.summary.lowCount}</span>
                                        ) : (
                                            <span style={{ color: 'var(--color-text-tertiary)' }}>—</span>
                                        )}
                                    </td>
                                    <td>
                                        <strong>{total}</strong>
                                    </td>
                                    <td>
                                        <div style={{ display: 'flex', gap: 'var(--space-2)' }}>
                                            <button
                                                className="btn btn-primary btn-sm"
                                                onClick={() => onRowClick?.(report)}
                                                title="View Details"
                                            >
                                                <Eye size={14} />
                                                View
                                            </button>
                                            <button
                                                className="btn btn-secondary btn-sm"
                                                onClick={() => onExportReport?.(report)}
                                                disabled={total === 0}
                                            >
                                                <Download size={14} />
                                                Export
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {isExpanded && (
                                    <tr key={`${report.id}-expanded`}>
                                        <td colSpan={10} style={{ padding: 0 }}>
                                            <ExpandedVulnerabilities vulnerabilities={report.vulnerabilities} />
                                        </td>
                                    </tr>
                                )}
                            </>
                        );
                    })}
                </tbody>
            </table>
        </div>
    );
}

function ExpandedVulnerabilities({ vulnerabilities }: { vulnerabilities: Vulnerability[] }) {
    const grouped = useMemo(() => {
        const groups: Record<string, Vulnerability[]> = {
            CRITICAL: [],
            HIGH: [],
            MEDIUM: [],
            LOW: [],
        };
        vulnerabilities.forEach((v) => {
            if (groups[v.severity]) {
                groups[v.severity].push(v);
            }
        });
        return groups;
    }, [vulnerabilities]);

    return (
        <div style={{
            background: 'var(--color-bg-secondary)',
            padding: 'var(--space-6)',
            borderTop: '1px solid var(--color-border)',
        }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: 'var(--space-4)' }}>
                {(['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'] as const).map((severity) => (
                    grouped[severity].length > 0 && (
                        <div key={severity} style={{
                            background: 'var(--color-bg-card)',
                            borderRadius: 'var(--radius-lg)',
                            padding: 'var(--space-4)',
                            border: '1px solid var(--color-border)',
                        }}>
                            <h4 style={{
                                marginBottom: 'var(--space-3)',
                                color: `var(--color-${severity.toLowerCase()})`,
                                fontSize: 'var(--font-size-sm)',
                                fontWeight: 600,
                            }}>
                                {severity} ({grouped[severity].length})
                            </h4>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 'var(--space-2)' }}>
                                {grouped[severity].slice(0, 10).map((vuln) => (
                                    <div key={vuln.id} style={{
                                        fontSize: 'var(--font-size-xs)',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        gap: '2px',
                                    }}>
                                        {vuln.primaryLink ? (
                                            <a
                                                href={vuln.primaryLink}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                style={{ fontFamily: 'monospace', fontWeight: 500 }}
                                            >
                                                {vuln.id}
                                            </a>
                                        ) : (
                                            <span style={{ fontFamily: 'monospace', fontWeight: 500 }}>{vuln.id}</span>
                                        )}
                                        {vuln.fixedVersion && (
                                            <span style={{ color: 'var(--color-success)', fontSize: '10px' }}>
                                                Fixed in: {vuln.fixedVersion}
                                            </span>
                                        )}
                                    </div>
                                ))}
                                {grouped[severity].length > 10 && (
                                    <span style={{ color: 'var(--color-text-tertiary)', fontSize: 'var(--font-size-xs)' }}>
                                        +{grouped[severity].length - 10} more
                                    </span>
                                )}
                            </div>
                        </div>
                    )
                ))}
            </div>
        </div>
    );
}
